<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>reTerminal E-Ink Calendar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.5.0/ical.min.js"></script>
    <style>
        :root { --bg: #fff; --text: #000; --today: #eee; }
        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        body, html { 
            background: #fff; color: #000; font-family: sans-serif; 
            margin: 0; padding: 0; width: 800px; height: 480px; overflow: hidden;
        }
        .container { display: flex; flex-direction: column; width: 800px; height: 480px; }
        header { 
            height: 50px; display: flex; justify-content: space-between; 
            align-items: center; padding: 0 15px; border-bottom: 4px solid #000; 
        }
        #month-label { font-size: 26px; font-weight: 900; }
        
        /* The "Heartbeat" - Keeps the E-Ink driver awake */
        #heartbeat { width: 8px; height: 8px; background: #000; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }

        .grid { display: grid; grid-template-columns: repeat(7, 1fr); grid-template-rows: 25px repeat(6, 1fr); flex: 1; }
        .h { background: #000; color: #fff; text-align: center; line-height: 25px; font-size: 12px; font-weight: 800; }
        .c { border-right: 1px solid #000; border-bottom: 1px solid #000; padding: 4px; overflow: hidden; }
        .c.today { background: var(--today); outline: 2px solid #000; outline-offset: -2px; }
        .c.off { color: #999; }
        .num { font-size: 16px; font-weight: 800; }
        .e { 
            font-size: 10px; font-weight: 700; background: #000; color: #fff; 
            padding: 1px 3px; margin-top: 2px; white-space: nowrap; 
            overflow: hidden; text-overflow: ellipsis; border-radius: 2px; 
        }
        #status-text { font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div id="month-label">LOADING...</div>
            <div style="display:flex; align-items:center; gap:10px;">
                <span id="status-text">SYNCING</span>
                <div id="heartbeat"></div>
            </div>
        </header>
        <div class="grid" id="g">
            <div class="h">MON</div><div class="h">TUE</div><div class="h">WED</div>
            <div class="h">THU</div><div class="h">FRI</div><div class="h">SAT</div>
            <div class="h">SUN</div>
        </div>
    </div>

    <script>
        const icalUrl = 'https://p108-caldav.icloud.com/published/2/MTUxMDYwNTYxNDE1MTA2MOcLt9DeC6aDOBzlZCUDejDdugx2IBT9HDhJA6jGIXwDHsR2_c0JH71EnIqBSkhBPTX-OE44UuANI0LecwDIOcg';
        const proxy = 'https://corsproxy.io/?' + encodeURIComponent(icalUrl);

        function buildInitialGrid() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            document.getElementById('month-label').innerText = now.toLocaleString('en-GB', { month: 'long', year: 'numeric' }).toUpperCase();

            const first = new Date(year, month, 1);
            let offset = first.getDay() - 1; if (offset === -1) offset = 6;
            const grid = document.getElementById('g');

            for (let i = 0; i < 42; i++) {
                const d = new Date(year, month, 1 - offset + i);
                const cell = document.createElement('div');
                cell.className = 'c' + (d.getMonth() !== month ? ' off' : '') + (d.toDateString() === now.toDateString() ? ' today' : '');
                cell.id = 'day-' + d.getFullYear() + '-' + d.getMonth() + '-' + d.getDate();
                cell.innerHTML = `<div class="num">${d.getDate()}</div><div class="ev-list"></div>`;
                grid.appendChild(cell);
            }
        }

        async function loadEvents() {
            try {
                const res = await fetch(proxy);
                const text = await res.text();
                
                const jcal = ICAL.parse(text);
                const comp = new ICAL.Component(jcal);
                const events = comp.getAllSubcomponents('vevent');

                events.forEach(ve => {
                    const ev = new ICAL.Event(ve);
                    const sd = ev.startDate.toJSDate();
                    const id = 'day-' + sd.getFullYear() + '-' + sd.getMonth() + '-' + sd.getDate();
                    const cell = document.getElementById(id);
                    if (cell) {
                        const list = cell.querySelector('.ev-list');
                        const div = document.createElement('div');
                        div.className = 'e';
                        div.innerText = ev.summary;
                        list.appendChild(div);
                    }
                });

                // Update status and STOP the heartbeat animation to allow E-Ink to settle
                document.getElementById('status-text').innerText = "UPDATED " + new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
                document.getElementById('heartbeat').style.animation = "none";
                document.getElementById('heartbeat').style.background = "#ccc";

            } catch (e) {
                document.getElementById('status-text').innerText = "OFFLINE";
                document.getElementById('heartbeat').style.animation = "none";
            }
        }

        // 1. Build the grid immediately so the screen has content within milliseconds
        buildInitialGrid();

        // 2. Wait a tiny bit for the E-Ink to finish its first "flash" before starting the heavy network call
        setTimeout(loadEvents, 500);
    </script>
</body>
</html>
