<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>reTerminal Month View (800x480)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.5.0/ical.min.js"></script>
    <style>
        :root {
            --bg: #ffffff;
            --text: #000000;
            --border: #000000;
            --today-bg: #e5e5e5;
        }

        * { box-sizing: border-box; }

        body, html {
            background-color: var(--bg);
            color: var(--text);
            font-family: "Amazon Ember", "Helvetica Neue", Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            /* Explicit reTerminal Resolution */
            width: 800px;
            height: 480px;
            overflow: hidden; 
        }

        .container {
            display: flex;
            flex-direction: column;
            width: 800px;
            height: 480px;
        }

        header {
            height: 50px; /* Slimmer header for 480px height */
            display: flex;
            align-items: center;
            padding-left: 15px;
            border-bottom: 5px solid var(--border);
        }

        #month-label {
            font-size: 28px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            /* Header row + 6 weeks to ensure all month configurations fit */
            grid-template-rows: 30px repeat(6, 1fr);
            flex-grow: 1;
            width: 100%;
        }

        .day-header {
            background: #000;
            color: #fff;
            text-align: center;
            line-height: 30px;
            font-weight: 800;
            font-size: 14px;
            text-transform: uppercase;
            border-right: 1px solid #fff;
        }

        .day-cell {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            padding: 4px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .day-cell.today {
            background-color: var(--today-bg);
            box-shadow: inset 0 0 0 2px #000;
        }

        .day-cell.other-month {
            background-color: #fafafa;
            color: #999;
        }

        .day-number {
            font-size: 16px;
            font-weight: 900;
            margin-bottom: 2px;
        }

        .events-container {
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: hidden;
        }

        .event-item {
            font-size: 10px;
            font-weight: 800;
            background: #000;
            color: #fff;
            padding: 1px 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-radius: 1px;
            line-height: 1.2;
        }

        .day-header:last-child, .day-cell:nth-child(7n) {
            border-right: none;
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div id="month-label">MONTH YEAR</div>
        </header>

        <div class="calendar-grid" id="calendar-grid">
            <div class="day-header">Mon</div>
            <div class="day-header">Tue</div>
            <div class="day-header">Wed</div>
            <div class="day-header">Thu</div>
            <div class="day-header">Fri</div>
            <div class="day-header">Sat</div>
            <div class="day-header">Sun</div>
        </div>
    </div>

    <script>
        const icalUrl = 'https://p108-caldav.icloud.com/published/2/MTUxMDYwNTYxNDE1MTA2MOcLt9DeC6aDOBzlZCUDejDdugx2IBT9HDhJA6jGIXwDHsR2_c0JH71EnIqBSkhBPTX-OE44UuANI0LecwDIOcg';
        const proxy = 'https://corsproxy.io/?' + encodeURIComponent(icalUrl);

        async function renderCalendar() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            document.getElementById('month-label').innerText = now.toLocaleString('en-GB', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1);
            let startOffset = firstDay.getDay() - 1; 
            if (startOffset === -1) startOffset = 6;

            const grid = document.getElementById('calendar-grid');
            const totalCells = 42; 

            for (let i = 0; i < totalCells; i++) {
                const dayDate = new Date(year, month, 1 - startOffset + i);
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                if (dayDate.getMonth() !== month) cell.classList.add('other-month');
                if (dayDate.toDateString() === now.toDateString()) cell.classList.add('today');

                cell.innerHTML = `
                    <div class="day-number">${dayDate.getDate()}</div>
                    <div class="events-container"></div>
                `;
                cell.dataset.date = dayDate.toDateString();
                grid.appendChild(cell);
            }

            try {
                const response = await fetch(proxy);
                const data = await response.text();
                const jcalData = ICAL.parse(data);
                const comp = new ICAL.Component(jcalData);
                const vevents = comp.getAllSubcomponents('vevent');

                vevents.forEach(ve => {
                    const event = new ICAL.Event(ve);
                    const dateKey = event.startDate.toJSDate().toDateString();
                    
                    const targetCell = grid.querySelector(`[data-date="${dateKey}"]`);
                    if (targetCell) {
                        const evDiv = document.createElement('div');
                        evDiv.className = 'event-item';
                        evDiv.innerText = event.summary;
                        targetCell.querySelector('.events-container').appendChild(evDiv);
                    }
                });
            } catch (e) {
                console.error("Calendar Sync Failed");
            }
        }

        renderCalendar();
    </script>
</body>
</html>
