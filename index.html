<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kindle Calendar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.5.0/ical.min.js"></script>
    <style>
        :root { --bg: #fff; --text: #000; --today-gray: #d0d0d0; }
        * { box-sizing: border-box; -webkit-font-smoothing: none; }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg); color: var(--text); 
            font-family: "Helvetica", Arial, sans-serif; overflow: hidden;
        }

        .container { display: flex; flex-direction: column; width: 100vw; height: 100vh; }
        
        header { 
            height: 10vh; display: flex; justify-content: space-between; 
            align-items: center; padding: 0 3vw; border-bottom: 6px solid #000; 
        }

        #month-label { font-size: 5vh; font-weight: 900; }
        #status { font-size: 2vh; font-weight: bold; }

        .grid { 
            display: flex; flex-wrap: wrap; flex: 1; width: 100%; 
            border-left: 1px solid #000;
        }

        .h, .c { width: 14.285%; border-right: 1px solid #000; border-bottom: 1px solid #000; }
        
        .h { 
            background: #000; color: #fff; height: 5vh; line-height: 5vh; 
            text-align: center; font-size: 2.2vh; font-weight: bold; 
        }

        .c { height: 14.1vh; padding: 8px; position: relative; }
        .c.today { background: var(--today-gray); box-shadow: inset 0 0 0 5px #000; }
        .c.off { color: #888; }

        .num { font-size: 3.5vh; font-weight: 900; margin-bottom: 4px; }
        .events-container { display: flex; flex-direction: column; gap: 3px; }

        .event-pill { 
            background: #000; color: #fff; font-size: 1.6vh; 
            padding: 2px 5px; border-radius: 3px; font-weight: bold;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div id="month-label">---</div>
            <div id="status">CONNECTING...</div>
        </header>
        <div id="g" class="grid"></div>
    </div>

    <script>
        // Your specific iCloud URL
        const rawUrl = 'webcal://p108-caldav.icloud.com/published/2/MTUxMDYwNTYxNDE1MTA2MOcLt9DeC6aDOBzlZCUDejDdugx2IBT9HDhJA6jGIXwDHsR2_c0JH71EnIqBSkhBPTX-OE44UuANI0LecwDIOcg';
        // Convert webcal to https and use a proxy to bypass Kindle CORS issues
        const icalUrl = 'https://corsproxy.io/?' + encodeURIComponent(rawUrl.replace('webcal://', 'https://'));

        function buildGrid() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const grid = document.getElementById('g');
            
            document.getElementById('month-label').innerText = now.toLocaleString('default', { month: 'long' }).toUpperCase();

            // Headers
            ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'].forEach(day => {
                grid.innerHTML += `<div class="h">${day}</div>`;
            });

            const firstDay = new Date(year, month, 1);
            let offset = firstDay.getDay() - 1; 
            if (offset === -1) offset = 6;

            for (let i = 0; i < 42; i++) {
                const d = new Date(year, month, 1 - offset + i);
                const isToday = d.toDateString() === now.toDateString();
                const isOff = d.getMonth() !== month;
                const dStr = d.toISOString().split('T')[0];

                const cell = document.createElement('div');
                cell.className = 'c' + (isOff ? ' off' : '') + (isToday ? ' today' : '');
                cell.id = 'date-' + dStr;
                cell.innerHTML = `<div class="num">${d.getDate()}</div><div class="events-container"></div>`;
                grid.appendChild(cell);
            }
        }

        function loadEvents() {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', icalUrl, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            const jcal = ICAL.parse(xhr.responseText);
                            const comp = new ICAL.Component(jcal);
                            const events = comp.getAllSubcomponents('vevent');

                            events.forEach(ve => {
                                const ev = new ICAL.Event(ve);
                                const dStr = ev.startDate.toJSDate().toISOString().split('T')[0];
                                const cell = document.getElementById('date-' + dStr);
                                if (cell) {
                                    const pill = document.createElement('div');
                                    pill.className = 'event-pill';
                                    pill.innerText = ev.summary;
                                    cell.querySelector('.events-container').appendChild(pill);
                                }
                            });
                            document.getElementById('status').innerText = 'LIVE SYNC';
                        } catch(e) {
                            document.getElementById('status').innerText = 'PARSE ERROR';
                        }
                    } else {
                        document.getElementById('status').innerText = 'LINK ERROR';
                    }
                }
            };
            xhr.send();
        }

        buildGrid();
        loadEvents();
    </script>
</body>
</html>
