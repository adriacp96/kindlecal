<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kindle E-Ink Calendar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.5.0/ical.min.js"></script>
    <style>
        :root { 
            --bg: #ffffff; 
            --text: #000000; 
            --border: #000000; 
            --today-bg: #e0e0e0; /* Light gray for E-ink */
            --off-text: #777777;
        }

        * { box-sizing: border-box; -webkit-font-smoothing: none; }

        body { 
            visibility: hidden; 
            background: var(--bg); 
            color: var(--text); 
            font-family: "Amazon Ember", Helvetica, Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            /* Paperwhite 2025 Landscape Resolution */
            width: 1680px; 
            height: 1264px; 
            overflow: hidden;
        }

        .container { 
            display: flex; 
            flex-direction: column; 
            width: 1680px; 
            height: 1264px; 
        }

        header { 
            height: 120px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 40px; 
            border-bottom: 8px solid var(--border); 
        }

        #month-label { font-size: 54px; font-weight: 900; text-transform: uppercase; }
        #status { font-size: 20px; font-weight: bold; }

        .grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            grid-template-rows: 60px repeat(6, 1fr); 
            flex: 1; 
        }

        .h { 
            background: #000; 
            color: #fff; 
            text-align: center; 
            line-height: 60px; 
            font-size: 28px; 
            font-weight: 800; 
            text-transform: uppercase; 
            border-right: 2px solid #fff;
        }

        .c { 
            border-right: 2px solid #000; 
            border-bottom: 2px solid #000; 
            padding: 15px; 
            display: flex;
            flex-direction: column;
        }

        /* Kindle doesn't do outlines well, using background and heavy border */
        .c.today { background: var(--today-bg); border: 10px solid #000; padding: 7px; }
        .c.off { color: var(--off-text); }

        .num { font-size: 36px; font-weight: 900; margin-bottom: 10px; }
        .events { display: flex; flex-direction: column; gap: 6px; }

        .e { 
            font-size: 22px; 
            font-weight: 700; 
            background: #000; 
            color: #fff; 
            padding: 6px 10px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            border-radius: 4px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div id="month-label"></div>
            <div id="status"></div>
        </header>
        <div class="grid" id="g">
            <div class="h">Mon</div><div class="h">Tue</div><div class="h">Wed</div>
            <div class="h">Thu</div><div class="h">Fri</div><div class="h">Sat</div>
            <div class="h">Sun</div>
        </div>
    </div>

    <script>
        const icalUrl = 'YOUR_ICAL_LINK_HERE'; 
        const proxy = 'https://corsproxy.io/?' + encodeURIComponent(icalUrl);

        function buildCalendarStructure() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            document.getElementById('month-label').innerText = now.toLocaleString('en-GB', { month: 'long', year: 'numeric' });
            document.getElementById('status').innerText = 'SYNCED: ' + now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

            const firstDayOfMonth = new Date(year, month, 1);
            let offset = firstDayOfMonth.getDay() - 1; 
            if (offset === -1) offset = 6;

            const grid = document.getElementById('g');
            
            for (let i = 0; i < 42; i++) {
                const d = new Date(year, month, 1 - offset + i);
                const cell = document.createElement('div');
                
                const isToday = d.toDateString() === now.toDateString();
                const isOffMonth = d.getMonth() !== month;
                
                cell.className = 'c' + (isOffMonth ? ' off' : '') + (isToday ? ' today' : '');
                cell.id = 'd-' + d.toDateString();
                cell.innerHTML = `<div class="num">${d.getDate()}</div><div class="events"></div>`;
                grid.appendChild(cell);
            }
        }

        async function init() {
            try {
                const res = await fetch(proxy);
                const text = await res.text();
                const jcal = ICAL.parse(text);
                const comp = new ICAL.Component(jcal);
                const events = comp.getAllSubcomponents('vevent');

                buildCalendarStructure();

                events.forEach(ve => {
                    const ev = new ICAL.Event(ve);
                    const dateKey = 'd-' + ev.startDate.toJSDate().toDateString();
                    const cell = document.getElementById(dateKey);
                    
                    if (cell) {
                        const container = cell.querySelector('.events');
                        const div = document.createElement('div');
                        div.className = 'e';
                        div.innerText = ev.summary;
                        container.appendChild(div);
                    }
                });

            } catch (err) {
                buildCalendarStructure();
                document.getElementById('status').innerText = "CONNECTION ERROR";
            } finally {
                // Delay visibility to let the Kindle browser finish rendering the layout
                setTimeout(() => {
                    document.body.style.visibility = 'visible';
                }, 500);
            }
        }

        init();
    </script>
</body>
</html>
